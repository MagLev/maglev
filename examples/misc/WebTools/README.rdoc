= WebTools Example

The WebTools Sinatra application running in MagLev allows you to explore a
MagLev Ruby application's Classes, Modules, Methods, Constants, and Ancestors
in a web browser.

It will also allow you to explore GemStone/S Smalltalk code, and to examine
detailed statistics about all processes connected to GemStone/S.

=== Setup

1. Start the MagLev server
    $ cd $MAGLEV_HOME
    $ maglev start

2. Install necessary gems:
    $ cd <to this directory>
    $ $MAGLEV_HOME/bin/bundle install

    ### Temporary workaround for https://magtrac.gemstone.com/ticket/879 ###
    $ maglev-gem pristine rack

== Viewing Ruby code

Run the WebTools Sinatra application

    $ rake

This will start WEBrick in your current window. Hit Ctl-C to stop.

Browse to http://localhost:9292/, click on a class or module, then
click on a constant or method. Results appear in the bottom pane, file
locations with line numbers in the bottom status line, and time spent
on the server/network/client in the top status line.

=== Add classes and modules from ActiveModel

<b>WARNING: If you already have an application loaded into MagLev, do not
run <code>rake meta</code> since it persists RubyGems and ActiveModel.
Use WebTools to explore <i>your application</i> instead. If you run
<code>rake meta</code>, run <code>maglev force-reload</code> afterwards
to load an empty database.</b>

    $ rake meta

Click on "Refresh View" in WebTools. Note that AValidPerson now appears in the
class list, as do a number of classes/modules from ActiveModel and ActiveSupport.

Click on the class AValidPerson and compare it with the source
(meta_demo.rb). Some things to note:

1. You can see all the methods generated by metaprogramming.
2. You can see the file and line number of the code that generated each
   method. This makes it simpler to track down which part of ActiveWhatever
   is messing with your code.
3. The <code>initialize</code> method is unchanged from the code
   in <code>meta_demo.rb</code>
4. The instance method <code>_callback_before_1</code> generated from
   <code>$MAGLEV_HOME/lib/maglev/gems/1.8/gems/activesupport-3.0.5/lib/active_support/callbacks.rb</code>
   shows the actual method name <code>_callback_before_1</code> instead of <code>#{method_name}</code>.

=== Modify meta_demo.rb and view new generated methods

Edit the file meta_demo.rb. Add :age to both validates_presence_of and attr_accessor.
The changed lines should look like

    validates_presence_of :first_name, :last_name, :age
    attr_accessor :first_name, :last_name, :age

Then

    $ rake meta

Click on "Refresh View" in WebTools. AValidPerson will now include the
new instance methods age and age=.

=== Add some data

    $ rake demodata

Click on "Refresh View" in WebTools. Note that AAADemo now appears in the
class list. Click on the class AAADemo and compare it with the source
(demo_data.rb).

== Viewing GemStone/S code, processes and statistics

The code for this example was inspired by the Smalltalk example found in
$MAGLEV_HOME/gemstone/examples/www. The Smalltalk example code can be
invoked from ruby (a demonstration of how to invoke Smalltalk from Ruby),
via:

    $ rake smalltalk:run

Then browse to http://localhost:8080/ and explore

Hit Ctl-C in the terminal window to stop.

== Known problems

Network timeouts are not caught. EAGAIN is not handled. If you're running WebTools on
a slow network, this may cause data to not appear in the bottom pane.

The line number displayed for evals is always 2. This will be fixed at a later date.

== CodeMirror

This project includes a subset of CodeMirror, copyrighted by Marijn Haverbeke.
See public/CodeMirror/LICENSE.
